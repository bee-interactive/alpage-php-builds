name: Build PHP Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      php_versions:
        description: 'PHP versions to build (comma-separated, e.g., 8.1,8.2,8.3,8.4,8.5)'
        required: false
        default: '8.1,8.2,8.3,8.4,8.5'

jobs:
  build:
    name: Build PHP ${{ matrix.php }} for macOS ARM64
    runs-on: macos-14  # macOS with Apple Silicon
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4', '8.5']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Homebrew dependencies
        run: |
          brew install \
            icu4c \
            libsodium \
            openssl@3 \
            freetype \
            libjpeg \
            webp \
            libpng \
            oniguruma \
            zlib \
            bzip2 \
            libzip \
            composer

      - name: Setup PHP for running static-php-cli
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          extensions: none
          coverage: none

      - name: Clone static-php-cli
        run: |
          git clone --depth=1 https://github.com/crazywhalecc/static-php-cli.git
          cd static-php-cli
          composer install --no-dev --optimize-autoloader

      - name: Download PHP sources
        run: |
          cd static-php-cli
          ./bin/spc download \
            --with-php=${{ matrix.php }} \
            --for-extensions=bcmath,bz2,calendar,ctype,curl,dom,exif,fileinfo,filter,ftp,gd,hash,iconv,intl,json,libxml,mbstring,mysqlnd,mysqli,openssl,pcntl,pdo,pdo_mysql,pdo_pgsql,pdo_sqlite,pgsql,phar,posix,session,simplexml,soap,sockets,sodium,sqlite3,tokenizer,xml,xmlreader,xmlwriter,zip,zlib,redis \
            --retry=3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build PHP CLI
        run: |
          cd static-php-cli
          ./bin/spc build \
            bcmath,bz2,calendar,ctype,curl,dom,exif,fileinfo,filter,ftp,gd,hash,iconv,intl,json,libxml,mbstring,mysqlnd,mysqli,openssl,pcntl,pdo,pdo_mysql,pdo_pgsql,pdo_sqlite,pgsql,phar,posix,session,simplexml,soap,sockets,sodium,sqlite3,tokenizer,xml,xmlreader,xmlwriter,zip,zlib,redis \
            --build-cli \
            --with-libs=icu4c,libsodium,openssl,freetype,jpeg,webp,png,oniguruma,zlib,bzip2,libzip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build PHP FPM
        run: |
          cd static-php-cli
          ./bin/spc build \
            bcmath,bz2,calendar,ctype,curl,dom,exif,fileinfo,filter,ftp,gd,hash,iconv,intl,json,libxml,mbstring,mysqlnd,mysqli,openssl,pcntl,pdo,pdo_mysql,pdo_pgsql,pdo_sqlite,pgsql,phar,posix,session,simplexml,soap,sockets,sodium,sqlite3,tokenizer,xml,xmlreader,xmlwriter,zip,zlib,redis \
            --build-fpm \
            --with-libs=icu4c,libsodium,openssl,freetype,jpeg,webp,png,oniguruma,zlib,bzip2,libzip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Test built binaries
        run: |
          echo "Testing PHP CLI:"
          ./static-php-cli/buildroot/bin/php -v
          echo ""
          echo "Loaded extensions:"
          ./static-php-cli/buildroot/bin/php -m
          echo ""
          echo "Checking critical extensions:"
          ./static-php-cli/buildroot/bin/php -r "echo 'sodium: ' . (extension_loaded('sodium') ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'intl: ' . (extension_loaded('intl') ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'redis: ' . (extension_loaded('redis') ? '✅' : '❌') . PHP_EOL;"

      - name: Package binaries
        run: |
          mkdir -p dist

          # Package CLI
          tar -czf dist/php-${{ matrix.php }}-cli-macos-aarch64.tar.gz \
            -C static-php-cli/buildroot/bin php

          # Package FPM
          tar -czf dist/php-${{ matrix.php }}-fpm-macos-aarch64.tar.gz \
            -C static-php-cli/buildroot/sbin php-fpm

          # Generate checksums
          cd dist
          shasum -a 256 *.tar.gz > SHA256SUMS
          cat SHA256SUMS

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php }}-macos-aarch64
          path: dist/*
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec cp {} release/ \;
          find artifacts -name "SHA256SUMS" -exec cat {} \; > release/SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # Alpage PHP Builds ${{ github.ref_name }}

            Custom PHP binaries with all commonly needed extensions included.

            ## What's Included

            ✅ **sodium** - Modern cryptography
            ✅ **intl** - Internationalization
            ✅ **redis** - Redis client
            ✅ **imagick** - ImageMagick bindings (when available)
            ✅ 40+ other standard extensions

            ## PHP Versions

            - PHP 8.1
            - PHP 8.2
            - PHP 8.3
            - PHP 8.4
            - PHP 8.5

            ## Architecture

            - macOS ARM64 (Apple Silicon)

            ## Verification

            ```bash
            # Download
            wget https://github.com/YOUR_USERNAME/alpage-php-builds/releases/download/${{ github.ref_name }}/php-8.4-cli-macos-aarch64.tar.gz

            # Verify checksum
            shasum -a 256 -c SHA256SUMS

            # Extract
            tar -xzf php-8.4-cli-macos-aarch64.tar.gz

            # Test
            ./php -v
            ./php -m | grep sodium
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
