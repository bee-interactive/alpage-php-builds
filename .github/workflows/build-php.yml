name: Build PHP Binaries

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      php_versions:
        description: 'PHP versions to build (comma-separated, e.g., 8.1,8.2,8.3,8.4,8.5)'
        required: false
        default: '8.1,8.2,8.3,8.4,8.5'

jobs:
  build:
    name: Build PHP ${{ matrix.php }} for macOS ARM64
    runs-on: macos-14
    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3', '8.4', '8.5']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP for running static-php-cli
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
          tools: composer
          extensions: none
          coverage: none

      - name: Clone static-php-cli
        run: |
          git clone --depth=1 https://github.com/crazywhalecc/static-php-cli.git
          cd static-php-cli
          composer install --no-dev --optimize-autoloader

      - name: Run spc doctor
        run: cd static-php-cli && ./bin/spc doctor --auto-fix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Download PHP sources
        run: |
          cd static-php-cli
          ./bin/spc download \
            --with-php=${{ matrix.php }} \
            --for-extensions=bcmath,bz2,calendar,ctype,curl,dom,exif,fileinfo,filter,ftp,gd,gmp,hash,iconv,intl,json,libxml,mbstring,mysqlnd,mysqli,openssl,pcntl,pdo,pdo_mysql,pdo_pgsql,pdo_sqlite,pgsql,phar,posix,session,simplexml,soap,sockets,sodium,sqlite3,tokenizer,xml,xmlreader,xmlwriter,xdebug,zip,zlib,redis \
            --for-libs=onig,libjpeg,libwebp \
            --retry=3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build PHP CLI and FPM
        run: |
          cd static-php-cli
          ./bin/spc build \
            bcmath,bz2,calendar,ctype,curl,dom,exif,fileinfo,filter,ftp,gd,gmp,hash,iconv,intl,json,libxml,mbstring,mysqlnd,mysqli,openssl,pcntl,pdo,pdo_mysql,pdo_pgsql,pdo_sqlite,pgsql,phar,posix,session,simplexml,soap,sockets,sodium,sqlite3,tokenizer,xml,xmlreader,xmlwriter,zip,zlib,redis \
            --with-libs=onig,libjpeg,libwebp \
            --build-cli \
            --build-fpm \
            --build-embed

      - name: Build xdebug with phpize
        continue-on-error: true
        run: |
          PHP_FAMILY="${{ matrix.php }}"

          # Select xdebug version by PHP family
          case "$PHP_FAMILY" in
            "8.1"|"8.2"|"8.3")
              XDEBUG_VERSION="3.3.2"
              ;;
            *)
              XDEBUG_VERSION="3.4.0"
              ;;
          esac

          echo "Building xdebug $XDEBUG_VERSION for PHP $PHP_FAMILY"

          PHPIZE=$(find static-php-cli/buildroot/bin -name "phpize" | head -1)
          PHP_CONFIG=$(find static-php-cli/buildroot/bin -name "php-config" | head -1)

          echo "phpize: $PHPIZE"
          echo "php-config: $PHP_CONFIG"

          if [ -z "$PHPIZE" ] || [ -z "$PHP_CONFIG" ]; then
            echo "phpize or php-config not found, cannot build xdebug"
            exit 1
          fi

          # Ensure autoconf is available
          brew install autoconf 2>/dev/null || true

          # Download xdebug source from GitHub
          curl -fSL "https://github.com/xdebug/xdebug/archive/refs/tags/${XDEBUG_VERSION}.tar.gz" -o xdebug.tar.gz
          tar -xzf xdebug.tar.gz
          cd "xdebug-${XDEBUG_VERSION}"

          # Build using phpize
          $PHPIZE
          ./configure --with-php-config="$PHP_CONFIG"
          make -j$(sysctl -n hw.ncpu)

          # Find and install the built .so
          XDEBUG_SO=$(find . -name "xdebug.so" | head -1)
          if [ -n "$XDEBUG_SO" ]; then
            mkdir -p ../static-php-cli/buildroot/modules
            cp "$XDEBUG_SO" ../static-php-cli/buildroot/modules/xdebug.so
            echo "xdebug.so installed ✅"
            ls -la ../static-php-cli/buildroot/modules/
          else
            echo "xdebug.so not found after build ❌"
            exit 1
          fi

      - name: Test built binaries
        run: |
          ./static-php-cli/buildroot/bin/php -v
          ./static-php-cli/buildroot/bin/php -m
          ./static-php-cli/buildroot/bin/php -r "echo 'sodium:    ' . (function_exists('sodium_crypto_secretbox') ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'mb_split:  ' . (function_exists('mb_split')  ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'imagejpeg: ' . (function_exists('imagejpeg') ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'imagewebp: ' . (function_exists('imagewebp') ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'intl:      ' . (extension_loaded('intl')     ? '✅' : '❌') . PHP_EOL;"
          ./static-php-cli/buildroot/bin/php -r "echo 'redis:     ' . (extension_loaded('redis')    ? '✅' : '❌') . PHP_EOL;"
          ls -la static-php-cli/buildroot/modules/ || echo "No modules directory"

      - name: Package binaries
        run: |
          mkdir -p dist
          tar -czf dist/php-${{ matrix.php }}-cli-macos-aarch64.tar.gz -C static-php-cli/buildroot/bin php
          FPM_PATH=$(find static-php-cli/buildroot -name "php-fpm" -type f | head -1)
          echo "Found php-fpm at: $FPM_PATH"
          tar -czf dist/php-${{ matrix.php }}-fpm-macos-aarch64.tar.gz -C "$(dirname $FPM_PATH)" php-fpm
          if [ -f static-php-cli/buildroot/modules/xdebug.so ]; then
            tar -czf dist/php-${{ matrix.php }}-xdebug-macos-aarch64.tar.gz -C static-php-cli/buildroot/modules xdebug.so
            echo "xdebug.so packaged ✅"
          else
            echo "xdebug.so not found ⚠️"
          fi
          cd dist && shasum -a 256 *.tar.gz > SHA256SUMS && cat SHA256SUMS

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ matrix.php }}-macos-aarch64
          path: dist/*
          retention-days: 7

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release
          find artifacts -name "*.tar.gz" -exec cp {} release/ \;
          find artifacts -name "SHA256SUMS" -exec cat {} \; > release/SHA256SUMS

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release/*
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            # Alpage PHP Builds ${{ github.ref_name }}

            Custom PHP binaries for macOS ARM64 (Apple Silicon).

            ## What's Included

            ✅ **sodium** - Modern cryptography
            ✅ **intl** - Internationalization
            ✅ **redis** - Redis client
            ✅ **gd** - Image manipulation
            ✅ **gmp** - Big number arithmetic
            ✅ **xdebug** - Debugging & code coverage (separate .so)
            ✅ 40+ other standard extensions

            ## PHP Versions

            - PHP 8.1 / 8.2 / 8.3 / 8.4 / 8.5

            ## Files per version

            - `php-{version}-cli-macos-aarch64.tar.gz` - PHP CLI binary
            - `php-{version}-fpm-macos-aarch64.tar.gz` - PHP FPM binary
            - `php-{version}-xdebug-macos-aarch64.tar.gz` - Xdebug extension (.so)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
